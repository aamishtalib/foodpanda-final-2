<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Foodpanda</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  
  <style>
    :root {
      --primary-color: #ff0080;
      --secondary-color: #1a1a2e;
      --light-bg: #f8f9fa;
      --border-color: #e1e1e1;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--light-bg);
    }
    
    .header {
      background: white;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .logo {
      display: flex;
      align-items: center;
      color: var(--primary-color);
      font-weight: 700;
      font-size: 24px;
      text-decoration: none;
    }
    
    .logo img {
      width: 35px;
      margin-right: 10px;
    }
    
    .nav {
      display: flex;
      gap: 20px;
    }
    
    .nav a {
      color: #333;
      text-decoration: none;
      font-weight: 500;
    }
    
    .nav a.active {
      color: var(--primary-color);
    }
    
    .logout-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background: #e0006e;
    }
    
    .dashboard-container {
      padding: 20px;
    }
    
    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
    }
    
    .add-dish-btn {
      background: #333;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .add-dish-btn:hover {
      background: #222;
    }
    
    .create-restaurant-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      cursor: pointer;
      margin: 30px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      max-width: 250px;
      transition: all 0.3s ease;
    }
    
    .create-restaurant-btn:hover {
      background: #e0006e;
    }
    
    .dishes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .dish-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .dish-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .dish-image {
      height: 200px;
      overflow: hidden;
      position: relative;
    }
    
    .dish-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .dish-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      color: white;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .edit-btn {
      background: #2c3e50;
    }
    
    .edit-btn:hover {
      background: #1a2530;
    }
    
    .delete-btn {
      background: #e74c3c;
    }
    
    .delete-btn:hover {
      background: #c0392b;
    }
    
    .dish-info {
      padding: 15px;
    }
    
    .dish-name {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .dish-price {
      color: #666;
      font-weight: 500;
      margin-bottom: 10px;
    }
    
    .dish-category {
      background: #f0f0f0;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      color: #666;
      display: inline-block;
    }
    
    .dish-description {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .read-more {
      display: block;
      text-align: center;
      margin-top: 10px;
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      padding: 20px;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }
    
    .modal-title {
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Poppins', sans-serif;
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .cancel-btn {
      background: #eee;
      color: #333;
    }
    
    .save-btn {
      background: var(--primary-color);
      color: white;
    }
    
    .save-btn:hover {
      background: #e0006e;
    }
    
    @media (max-width: 768px) {
      .dishes-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }
    
    @media (max-width: 576px) {
      .dishes-grid {
        grid-template-columns: 1fr;
      }
      
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <a href="../index.html" style="display: flex; align-items: center; gap: 10px;">
        <img src="../assets/real_panda_logo.png" alt="Foodpanda Logo" style="width: 40px; height: auto;">
        <span class="logo-text">foodpanda</span>
      </a>
    </div>
    
    <nav class="nav">
      <a href="../index.html">Home</a>
      <a href="new-dashboard.html" class="active">Dashboard</a>
    </nav>
    
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </header>
  
  <!-- Main Content -->
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
        <img src="../assets/real_panda_logo.png" alt="Foodpanda Logo" style="width: 80px; height: auto;">
        <h1 class="dashboard-title">Admin Dashboard</h1>
      </div>
      <button class="add-dish-btn" id="addDishBtn">
        <i class="fas fa-plus"></i> Add New Dish
      </button>
    </div>
    
    <div class="dishes-grid" id="dishesGrid">
      <!-- Pizza -->
      <div class="dish-card" data-id="example-pizza">
        <div class="dish-image">
          <img src="https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?auto=format&fit=crop&q=80&w=1000" alt="Pizza">
          <div class="dish-actions">
            <button class="action-btn edit-btn">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="dish-info">
          <h3 class="dish-name">Pizza</h3>
          <p class="dish-price">PKR 2500</p>
          <span class="dish-category">Main Course</span>
          <p class="dish-description">Chizzy Pizza</p>
          <a href="#" class="read-more">Read More</a>
        </div>
      </div>
      
      <!-- Cola Next -->
      <div class="dish-card" data-id="example-cola">
        <div class="dish-image">
          <img src="https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&q=80&w=1000" alt="Cola Next">
          <div class="dish-actions">
            <button class="action-btn edit-btn">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="dish-info">
          <h3 class="dish-name">Cola Next</h3>
          <p class="dish-price">PKR 120</p>
          <span class="dish-category">Appetizer</span>
          <p class="dish-description">Tab Tabi Tab</p>
          <a href="#" class="read-more">Read More</a>
        </div>
      </div>
      
      <!-- Burger -->
      <div class="dish-card" data-id="example-burger">
        <div class="dish-image">
          <img src="https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&q=80&w=1000" alt="Burger">
          <div class="dish-actions">
            <button class="action-btn edit-btn">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="dish-info">
          <h3 class="dish-name">Burger</h3>
          <p class="dish-price">PKR 1400</p>
          <span class="dish-category">Main Course</span>
          <p class="dish-description">You can find image details on Google</p>
          <a href="#" class="read-more">Read More</a>
        </div>
      </div>
      
      <!-- Bun Kabab -->
      <div class="dish-card" data-id="example-bun-kabab">
        <div class="dish-image">
          <img src="https://images.unsplash.com/photo-1633383718081-22ac93e3db65?auto=format&fit=crop&q=80&w=1000" alt="Bun Kabab">
          <div class="dish-actions">
            <button class="action-btn edit-btn">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="dish-info">
          <h3 class="dish-name">Bun Kabab</h3>
          <p class="dish-price">PKR 150</p>
          <span class="dish-category">Main Course</span>
          <p class="dish-description">Lorem ipsum dolor sit amet...</p>
          <a href="#" class="read-more">Read More</a>
        </div>
      </div>
    </div>
    
    <!-- Create Restaurant button -->
    <button class="create-restaurant-btn" id="createRestaurantBtn">
      <i class="fas fa-store"></i> Create Restaurant
    </button>
  </div>
  
  <!-- Add/Edit Dish Modal -->
  <div class="modal" id="dishModal">
    <div class="modal-content">
      <button class="close-modal" id="closeModal">×</button>
      <h2 class="modal-title" id="modalTitle">Add New Dish</h2>
      
      <form id="dishForm">
        <div class="form-group">
          <label class="form-label" for="dishName">Dish Name</label>
          <input type="text" id="dishName" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="dishPrice">Price (PKR)</label>
          <input type="number" id="dishPrice" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="dishCategory">Category</label>
          <select id="dishCategory" class="form-select" required>
            <option value="">Select Category</option>
            <option value="main-course">Main Course</option>
            <option value="appetizer">Appetizer</option>
            <option value="dessert">Dessert</option>
            <option value="beverage">Beverage</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="dishDescription">Description</label>
          <textarea id="dishDescription" class="form-textarea"></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="dishImage">Image</label>
          <input type="file" id="dishImage" accept="image/*">
        </div>
        
        <div class="modal-footer">
          <button type="button" class="modal-btn cancel-btn" id="cancelBtn">Cancel</button>
          <button type="submit" class="modal-btn save-btn">Save Dish</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Restaurant Modal -->
  <div class="modal" id="restaurantModal">
    <div class="modal-content">
      <button class="close-modal" id="closeRestaurantModal">×</button>
      <h2 class="modal-title">Create Restaurant</h2>
      
      <form id="restaurantForm">
        <div class="form-group">
          <label class="form-label" for="restaurantName">Restaurant Name</label>
          <input type="text" id="restaurantName" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="restaurantDescription">Description</label>
          <textarea id="restaurantDescription" class="form-textarea" required></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="restaurantCity">City</label>
          <input type="text" id="restaurantCity" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="restaurantDeliveryTime">Delivery Time (e.g. 20-30 min)</label>
          <input type="text" id="restaurantDeliveryTime" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="restaurantImage">Restaurant Image</label>
          <input type="file" id="restaurantImage" accept="image/*">
        </div>
        
        <div class="modal-footer">
          <button type="button" class="modal-btn cancel-btn" id="cancelRestaurantBtn">Cancel</button>
          <button type="submit" class="modal-btn save-btn">Create Restaurant</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Initialize Firebase -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDgx9bKrdhSz5Z5IS9sG1mxGlVnbyJNRG4",
        authDomain: "foodpanda-clone-7340c.firebaseapp.com",
        projectId: "foodpanda-clone-7340c",
        storageBucket: "foodpanda-clone-7340c.appspot.com",
        messagingSenderId: "735457527905",
        appId: "1:735457527905:web:08ae983fd213dc41b34220",
        measurementId: "G-YLE16W2SZJ"
      };
      
      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      
      // Get Firebase services
      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();
      
      // References
      const dishesGrid = document.getElementById('dishesGrid');
      const noItemsMessage = document.createElement('p');
      noItemsMessage.textContent = 'No dishes found. Add your first dish by clicking the "Add New Dish" button.';
      noItemsMessage.style.textAlign = 'center';
      noItemsMessage.style.marginTop = '50px';
      noItemsMessage.style.color = '#666';
      noItemsMessage.style.display = 'none';
      dishesGrid.after(noItemsMessage);
      
      // Store current restaurant ID
      let currentRestaurantId = null;
      let currentDishId = null;
      
      // Check authentication status
      auth.onAuthStateChanged(function(user) {
        if (user) {
          console.log('User is signed in:', user.email);
          // Check if user is admin and get restaurant info
          checkAdminAndLoadData(user.uid);
          
          // Make sure the button listeners are added to example dishes
          addButtonListeners();
        } else {
          console.log('No user is signed in.');
          // Redirect to login page
          window.location.href = '../index.html';
        }
      });
      
      // Check if user is admin and load their restaurant data
      async function checkAdminAndLoadData(userId) {
        try {
          // Get user data
          const userDoc = await db.collection('users').doc(userId).get();
          
          if (userDoc.exists && userDoc.data().userType === 'admin') {
            // Always make restaurant functionality available
            // Create a default restaurant ID if none exists
            currentRestaurantId = 'default-restaurant-id';
            
            // Load dishes - but keep existing demo dishes
            loadCategories(currentRestaurantId);
            
            // Hide create restaurant button completely
            document.getElementById('createRestaurantBtn').style.display = 'none';
          } else {
            // Not an admin user
            showMessage('You must be an admin to access this page.', 'error');
            setTimeout(() => {
              window.location.href = '../index.html';
            }, 2000);
          }
        } catch (error) {
          console.error('Error checking admin status:', error);
          showMessage('An error occurred while loading data.', 'error');
        }
      }
      
      // Load dishes from Firestore - modified to keep example dishes
      async function loadDishes(restaurantId) {
        try {
          // Keep the existing dishes - don't clear the grid
          // dishesGrid.innerHTML = ''; (this line is removed)
          
          // Get menu items from Firestore
          const menuItemsSnapshot = await db.collection('menu_items')
            .where('restaurantId', '==', restaurantId)
            .get();
          
          // Hide no items message since we have example dishes
          noItemsMessage.style.display = 'none';
          
          // Get all categories to display category names
          const categoriesSnapshot = await db.collection('categories')
            .where('restaurantId', '==', restaurantId)
            .get();
          
          const categories = {};
          categoriesSnapshot.forEach(doc => {
            categories[doc.id] = doc.data().name;
          });
          
          // Display dishes from Firestore - add to existing ones
          menuItemsSnapshot.forEach(doc => {
            const dish = doc.data();
            const dishId = doc.id;
            
            // Create dish card
            const dishCard = createDishCard(dishId, dish, categories[dish.categoryId] || 'Uncategorized');
            dishesGrid.appendChild(dishCard);
          });
          
          // Add edit and delete functionality to new buttons
          addButtonListeners();
        } catch (error) {
          console.error('Error loading dishes:', error);
          showMessage('An error occurred while loading dishes.', 'error');
        }
      }
      
      // Create a dish card element
      function createDishCard(id, dish, categoryName) {
        const card = document.createElement('div');
        card.className = 'dish-card';
        card.dataset.id = id;
        
        const imageUrl = dish.image || 'https://via.placeholder.com/500x300?text=No+Image';
        
        card.innerHTML = `
          <div class="dish-image">
            <img src="${imageUrl}" alt="${dish.name}">
            <div class="dish-actions">
              <button class="action-btn edit-btn">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete-btn">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="dish-info">
            <h3 class="dish-name">${dish.name}</h3>
            <p class="dish-price">PKR ${dish.price}</p>
            <span class="dish-category">${categoryName}</span>
            <p class="dish-description">${dish.description || 'No description'}</p>
            <a href="#" class="read-more">Read More</a>
          </div>
        `;
        
        return card;
      }
      
      // Add event listeners to edit and delete buttons
      function addButtonListeners() {
        // Edit dish functionality
        const editButtons = document.querySelectorAll('.edit-btn');
        editButtons.forEach(button => {
          button.addEventListener('click', function() {
            const card = this.closest('.dish-card');
            currentDishId = card.getAttribute('data-id');
            
            console.log('Edit button clicked for dish ID:', currentDishId);
            
            const name = card.querySelector('.dish-name').textContent;
            const price = card.querySelector('.dish-price').textContent.replace('PKR ', '');
            const category = card.querySelector('.dish-category').textContent;
            const description = card.querySelector('.dish-description').textContent;
            
            // Populate form
            document.getElementById('dishName').value = name;
            document.getElementById('dishPrice').value = price;
            document.getElementById('dishDescription').value = description !== 'No description' ? description : '';
            
            // Load categories for the dropdown
            loadCategories(currentRestaurantId, category);
            
            // Open modal
            document.getElementById('modalTitle').textContent = 'Edit Dish';
            modal.classList.add('active');
          });
        });
        
        // Delete dish functionality
        const deleteButtons = document.querySelectorAll('.delete-btn');
        deleteButtons.forEach(button => {
          button.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this dish?')) {
              const card = this.closest('.dish-card');
              const dishId = card.dataset.id;
              
              // Delete from Firestore
              deleteDish(dishId);
            }
          });
        });
        
        // Read more functionality
        const readMoreLinks = document.querySelectorAll('.read-more');
        readMoreLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const description = this.previousElementSibling;
            
            if (description.style.webkitLineClamp === 'none') {
              description.style.webkitLineClamp = '2';
              this.textContent = 'Read More';
            } else {
              description.style.webkitLineClamp = 'none';
              this.textContent = 'Read Less';
            }
          });
        });
      }
      
      // Load categories for dropdown
      async function loadCategories(restaurantId, selectedCategory = null) {
        try {
          const categorySelect = document.getElementById('dishCategory');
          categorySelect.innerHTML = '<option value="">Select Category</option>';
          
          // Add default categories to ensure there are always options
          const defaultCategories = [
            { id: 'main-course', name: 'Main Course' },
            { id: 'appetizer', name: 'Appetizer' },
            { id: 'dessert', name: 'Dessert' },
            { id: 'beverage', name: 'Beverage' }
          ];
          
          defaultCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            
            // Select if editing and matches
            if (selectedCategory && cat.name === selectedCategory) {
              option.selected = true;
            }
            
            categorySelect.appendChild(option);
          });
          
          // Try to get categories from Firestore as well
          const categoriesSnapshot = await db.collection('categories')
            .where('restaurantId', '==', restaurantId)
            .get();
          
          if (!categoriesSnapshot.empty) {
            // Add Firestore categories to dropdown
            categoriesSnapshot.forEach(doc => {
              const category = doc.data();
              // Check if we already have this category (by name)
              const existingOption = Array.from(categorySelect.options).find(
                opt => opt.textContent.toLowerCase() === category.name.toLowerCase()
              );
              
              if (!existingOption) {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = category.name;
                
                // Select if editing and matches
                if (selectedCategory && category.name === selectedCategory) {
                  option.selected = true;
                }
                
                categorySelect.appendChild(option);
              }
            });
          }
        } catch (error) {
          console.error('Error loading categories:', error);
        }
      }
      
      // Delete dish from Firestore
      async function deleteDish(dishId) {
        try {
          await db.collection('menu_items').doc(dishId).delete();
          
          // Remove from UI
          const card = document.querySelector(`.dish-card[data-id="${dishId}"]`);
          card.remove();
          
          // Show success message
          showMessage('Dish deleted successfully.', 'success');
          
          // If no more dishes, show no items message
          if (dishesGrid.children.length === 0) {
            noItemsMessage.style.display = 'block';
          }
        } catch (error) {
          console.error('Error deleting dish:', error);
          showMessage('An error occurred while deleting the dish.', 'error');
        }
      }
      
      // Show message function
      function showMessage(message, type = 'info') {
        // Create message element if not exists
        let messageContainer = document.querySelector('.message-container');
        
        if (!messageContainer) {
          messageContainer = document.createElement('div');
          messageContainer.className = 'message-container';
          messageContainer.style.position = 'fixed';
          messageContainer.style.top = '20px';
          messageContainer.style.right = '20px';
          messageContainer.style.zIndex = '1000';
          document.body.appendChild(messageContainer);
        }
        
        // Create message
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;
        messageElement.textContent = message;
        
        // Style message
        messageElement.style.padding = '12px 20px';
        messageElement.style.marginBottom = '10px';
        messageElement.style.borderRadius = '5px';
        messageElement.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
        messageElement.style.transition = 'all 0.3s ease';
        
        // Type-specific styles
        if (type === 'success') {
          messageElement.style.backgroundColor = '#4CAF50';
          messageElement.style.color = 'white';
        } else if (type === 'error') {
          messageElement.style.backgroundColor = '#F44336';
          messageElement.style.color = 'white';
        } else {
          messageElement.style.backgroundColor = '#2196F3';
          messageElement.style.color = 'white';
        }
        
        // Add to container
        messageContainer.appendChild(messageElement);
        
        // Remove after 3 seconds
        setTimeout(() => {
          messageElement.style.opacity = '0';
          setTimeout(() => {
            messageElement.remove();
          }, 300);
        }, 3000);
      }
      
      // Logout functionality
      document.getElementById('logoutBtn').addEventListener('click', function() {
        auth.signOut().then(function() {
          console.log('User signed out successfully');
          window.location.href = '../index.html';
        }).catch(function(error) {
          console.error('Sign out error:', error);
          showMessage('An error occurred while signing out.', 'error');
        });
      });
      
      // Modal functionality
      const modal = document.getElementById('dishModal');
      const restaurantModal = document.getElementById('restaurantModal');
      const addDishBtn = document.getElementById('addDishBtn');
      const createRestaurantBtn = document.getElementById('createRestaurantBtn');
      const closeModal = document.getElementById('closeModal');
      const closeRestaurantModal = document.getElementById('closeRestaurantModal');
      const cancelBtn = document.getElementById('cancelBtn');
      const cancelRestaurantBtn = document.getElementById('cancelRestaurantBtn');
      const dishForm = document.getElementById('dishForm');
      const restaurantForm = document.getElementById('restaurantForm');
      
      // Open modal for adding new dish
      addDishBtn.addEventListener('click', function() {
        // Reset form and set for adding
        dishForm.reset();
        currentDishId = null;
        document.getElementById('modalTitle').textContent = 'Add New Dish';
        
        // Load categories
        loadCategories(currentRestaurantId);
        
        // Show modal
        modal.classList.add('active');
      });
      
      // Open modal for creating restaurant
      createRestaurantBtn.addEventListener('click', function() {
        restaurantForm.reset();
        restaurantModal.classList.add('active');
      });
      
      // Close modal function
      function closeModalFunction() {
        modal.classList.remove('active');
      }
      
      function closeRestaurantModalFunction() {
        restaurantModal.classList.remove('active');
      }
      
      // Close modal events
      closeModal.addEventListener('click', closeModalFunction);
      cancelBtn.addEventListener('click', closeModalFunction);
      closeRestaurantModal.addEventListener('click', closeRestaurantModalFunction);
      cancelRestaurantBtn.addEventListener('click', closeRestaurantModalFunction);
      
      // Close modal when clicking outside
      modal.addEventListener('click', function(event) {
        if (event.target === modal) {
          closeModalFunction();
        }
      });
      
      restaurantModal.addEventListener('click', function(event) {
        if (event.target === restaurantModal) {
          closeRestaurantModalFunction();
        }
      });
      
      // Form submission
      dishForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        try {
          // Get form values
          const name = document.getElementById('dishName').value;
          const price = document.getElementById('dishPrice').value;
          const categoryId = document.getElementById('dishCategory').value || 'default-category';
          const description = document.getElementById('dishDescription').value;
          const imageFile = document.getElementById('dishImage').files[0];
          
          if (!name || !price) {
            showMessage('Please fill in all required fields.', 'error');
            return;
          }
          
          let imageUrl = '';
          
          // Upload image if selected
          if (imageFile) {
            const storageRef = storage.ref(`dishes/${Date.now()}_${imageFile.name}`);
            await storageRef.put(imageFile);
            imageUrl = await storageRef.getDownloadURL();
          }
          
          const dishData = {
            name,
            price: Number(price),
            categoryId,
            restaurantId: currentRestaurantId,
            description,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          if (imageUrl) {
            dishData.image = imageUrl;
          }
          
          // Check if we're editing an example dish (ID starts with "example-")
          const isExampleDish = currentDishId && currentDishId.startsWith('example-');
          
          if (currentDishId && !isExampleDish) {
            // Update existing dish in Firestore
            await db.collection('menu_items').doc(currentDishId).update(dishData);
            showMessage('Dish updated successfully.', 'success');
          } else if (isExampleDish) {
            // For example dishes, just update the UI
            console.log('Updating example dish:', currentDishId);
            updateDishCardUI(currentDishId, dishData);
            showMessage('Example dish updated.', 'success');
          } else {
            // Add new dish to Firestore
            dishData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            const newDishRef = await db.collection('menu_items').add(dishData);
            
            // Create a new dish card and add it to the grid
            const newDish = {
              ...dishData,
              id: newDishRef.id
            };
            const categoryName = document.getElementById('dishCategory').options[document.getElementById('dishCategory').selectedIndex].text;
            const newCard = createDishCard(newDishRef.id, newDish, categoryName);
            dishesGrid.appendChild(newCard);
            
            // Add listeners to the new card
            addButtonListeners();
            
            showMessage('Dish added successfully.', 'success');
          }
          
          // Close modal
          closeModalFunction();
        } catch (error) {
          console.error('Error saving dish:', error);
          showMessage('An error occurred while saving the dish.', 'error');
        }
      });
      
      // Helper function to update a dish card in the UI
      function updateDishCardUI(dishId, dishData) {
        const card = document.querySelector(`.dish-card[data-id="${dishId}"]`);
        if (!card) {
          console.error('Card not found for ID:', dishId);
          return;
        }
        
        // Update card contents
        card.querySelector('.dish-name').textContent = dishData.name;
        card.querySelector('.dish-price').textContent = `PKR ${dishData.price}`;
        
        // Get category name from select
        const categorySelect = document.getElementById('dishCategory');
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categoryName = selectedOption ? selectedOption.textContent : 'Uncategorized';
        card.querySelector('.dish-category').textContent = categoryName;
        
        // Update description
        card.querySelector('.dish-description').textContent = dishData.description || 'No description';
        
        // Update image if provided
        if (dishData.image) {
          card.querySelector('img').src = dishData.image;
        }
      }
      
      // Restaurant form submission
      restaurantForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        try {
          // Get form values
          const name = document.getElementById('restaurantName').value;
          const description = document.getElementById('restaurantDescription').value;
          const city = document.getElementById('restaurantCity').value;
          const deliveryTime = document.getElementById('restaurantDeliveryTime').value;
          const imageFile = document.getElementById('restaurantImage').files[0];
          
          if (!name || !description || !city || !deliveryTime) {
            showMessage('Please fill in all required fields.', 'error');
            return;
          }
          
          let imageUrl = 'assets/images (' + (Math.floor(Math.random() * 16) + 1) + ').jpg';
          
          // Upload image if selected
          if (imageFile) {
            const storageRef = storage.ref(`restaurants/${Date.now()}_${imageFile.name}`);
            await storageRef.put(imageFile);
            imageUrl = await storageRef.getDownloadURL();
          }
          
          const restaurantData = {
            name,
            description,
            city,
            deliveryTime,
            image: imageUrl,
            rating: 4.5, // Default rating
            ownerId: auth.currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          // Create restaurant in Firestore
          const docRef = await db.collection('restaurants').add(restaurantData);
          currentRestaurantId = docRef.id;
          
          // Close modal and show success message
          closeRestaurantModalFunction();
          showMessage('Restaurant created successfully!', 'success');
          
          // Create default categories
          await createDefaultCategories(currentRestaurantId);
          
          // Hide create restaurant button and show add dish button
          document.getElementById('createRestaurantBtn').style.display = 'none';
          document.getElementById('addDishBtn').style.display = 'flex';
          
          // Remove no items message
          noItemsMessage.style.display = 'none';
          
        } catch (error) {
          console.error('Error creating restaurant:', error);
          showMessage('An error occurred while creating the restaurant.', 'error');
        }
      });
      
      // Create default categories
      async function createDefaultCategories(restaurantId) {
        try {
          // Create two default categories
          const defaultCategories = [
            {
              name: 'Main Dishes',
              description: 'Our signature main courses',
              restaurantId: restaurantId,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            },
            {
              name: 'Desserts', 
              description: 'Sweet treats to end your meal',
              restaurantId: restaurantId,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }
          ];
          
          for (const category of defaultCategories) {
            await db.collection('categories').add(category);
          }
          
          return true;
        } catch (error) {
          console.error('Error creating default categories:', error);
          return false;
        }
      }
    });
  </script>
</body>
</html> 